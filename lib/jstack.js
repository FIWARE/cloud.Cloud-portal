var JSTACK=JSTACK||{};JSTACK.VERSION="0.1";JSTACK.AUTHORS="GING";JSTACK.Comm=function(d,c){var f=function(d,e,b,a,h,i){var f=new XMLHttpRequest;f.open(d,e,!0);f.setRequestHeader("Content-Type","application/json");f.setRequestHeader("Accept","application/json");f.onreadystatechange=function(){if(4==f.readyState)switch(f.status){case 100:case 200:case 201:case 202:case 203:case 204:case 205:var a=c;f.responseText!=c&&""!=f.responseText&&(a=JSON.parse(f.responseText));h(a);break;case 400:i("400 Bad Request");break;case 401:i("401 Unauthorized");break;case 403:i("403 Forbidden");
break;default:i(f.status+" Error")}};a!=c&&f.setRequestHeader("X-Auth-Token",a);b!=c?(d=JSON.stringify(b),f.send(d)):f.send()};return{get:function(d,e,b,a){f("GET",d,c,e,b,a)},post:function(c,d,b,a,h){f("POST",c,d,b,a,h)},put:function(c,d,b,a,h){f("PUT",c,d,b,a,h)},del:function(d,e,b,a){f("DELETE",d,c,e,b,a)}}}(JSTACK);JSTACK.Utils=function(d){return{encode:function(c){var f="",g,e,b,a,h,i,j=0,c=c.replace(/\r\n/g,"\n");e="";for(b=0;b<c.length;b++)a=c.charCodeAt(b),128>a?e+=String.fromCharCode(a):(127<a&&2048>a?e+=String.fromCharCode(a>>6|192):(e+=String.fromCharCode(a>>12|224),e+=String.fromCharCode(a>>6&63|128)),e+=String.fromCharCode(a&63|128));for(c=e;j<c.length;)g=c.charCodeAt(j++),e=c.charCodeAt(j++),b=c.charCodeAt(j++),a=g>>2,g=(g&3)<<4|e>>4,h=(e&15)<<2|b>>6,i=b&63,isNaN(e)?h=i=64:isNaN(b)&&(i=64),f=f+d.Utils._keyStr.charAt(a)+
Base64._keyStr.charAt(g)+d.Utils._keyStr.charAt(h)+Base64._keyStr.charAt(i);return f},decode:function(c){for(var f="",g,e,b,a,h,i=0,c=c.replace(/[^A-Za-z0-9\+\/\=]/g,"");i<c.length;)g=d.Utils._keyStr.indexOf(c.charAt(i++)),e=d.Utils._keyStr.indexOf(c.charAt(i++)),a=d.Utils._keyStr.indexOf(c.charAt(i++)),h=d.Utils._keyStr.indexOf(c.charAt(i++)),g=g<<2|e>>4,e=(e&15)<<4|a>>2,b=(a&3)<<6|h,f+=String.fromCharCode(g),64!=a&&(f+=String.fromCharCode(e)),64!=h&&(f+=String.fromCharCode(b));c=f;f="";for(h=c1=
c2=a=0;a<c.length;)h=c.charCodeAt(a),128>h?(f+=String.fromCharCode(h),a++):191<h&&224>h?(c2=c.charCodeAt(a+1),f+=String.fromCharCode((h&31)<<6|c2&63),a+=2):(c2=c.charCodeAt(a+1),c3=c.charCodeAt(a+2),f+=String.fromCharCode((h&15)<<12|(c2&63)<<6|c3&63),a+=3);return f}}}(JSTACK);JSTACK.Keystone=function(d,c){var f={DISCONNECTED:0,AUTHENTICATING:1,AUTHENTICATED:2,AUTHENTICATION_ERROR:3},g={url:c,currentstate:c,access:c,token:c};return{STATES:f,params:g,init:function(d){g.url=d;g.access=c;g.token=c;g.currentstate=f.DISCONNECTED},authenticate:function(e,b,a,h,i,j){var k={},k=a!=c?{auth:{token:{id:a}}}:{auth:{passwordCredentials:{username:e,password:b}}};h!==c&&(k.auth.tenantId=h);g.currentstate=f.AUTHENTICATING;d.Comm.post(g.url+"tokens",k,c,function(a){g.currentstate=d.Keystone.STATES.AUTHENTICATED;
g.access=a.access;g.token=g.access.token.id;i!=c&&i(a)},function(a){g.currentstate=f.AUTHENTICATION_ERROR;j(a)})},gettenants:function(f){g.currentstate==d.Keystone.STATES.AUTHENTICATED&&d.Comm.get(g.url+"tenants",g.token,function(b){f!=c&&f(b)},function(b){throw Error(b);})},getservice:function(d){if(g.currentstate!=f.AUTHENTICATED)return c;for(var b in g.access.serviceCatalog){var a=g.access.serviceCatalog[b];if(d==a.type)return a}return c},getservicelist:function(){return g.currentstate!=f.AUTHENTICATED?
c:g.access.serviceCatalog}}}(JSTACK);JSTACK.Nova=function(d,c){var f=c,g=function(){return d.Keystone!=c&&d.Keystone.params.currentstate==d.Keystone.STATES.AUTHENTICATED?(f=d.Keystone.getservice("compute").endpoints[0].adminURL,!0):!1},e=function(b,a,h,e){g()&&d.Comm.post(f+"/servers/"+b+"/action",a,d.Keystone.params.token,function(a){e!=c&&e(a)},function(a){throw Error(a);})};return{getserverlist:function(b,a,h){if(g()){var e=f+"/servers";b!=c&b&&(e+="/detail");a&&(e+="?all_tenants="+a);d.Comm.get(e,d.Keystone.params.token,function(a){h!=
c&&h(a)},function(a){throw Error(a);})}},getserverdetail:function(b,a){g()&&d.Comm.get(f+"/servers/"+b,d.Keystone.params.token,function(b){a!=c&&a(b)},function(a){throw Error(a);})},getserverips:function(b,a,h){g()&&(b=f+"/servers/"+b+"/ips",a!=c&&(b+="/"+a),d.Comm.get(b,d.Keystone.params.token,function(a){h!=c&&h(a)},function(a){throw Error(a);}))},updateserver:function(b,a,h){g()&&a!=c&&d.Comm.put(f+"/servers/"+b,{server:{name:a}},d.Keystone.params.token,function(a){h!=c&&h(a)},function(a){throw Error(a);
})},createserver:function(b,a,h,e,j,k,l,m,n,o){if(g()){b={server:{name:b,imageRef:a,flavorRef:h}};e!=c&&(b.server.key_name=e);j!=c&&(b.server.user_data=d.Utils.encode(j));if(k!=c){var e=[],p;for(p in k)e.push({name:k[p]});b.server.security_groups=e}l==c&&(l=1);b.server.min_count=l;m==c&&(m=1);b.server.max_count=m;n!=c&&(b.server.availability_zone=d.Utils.encode(n));d.Comm.post(f+"/servers",b,d.Keystone.params.token,function(a){o!=c&&o(a)},function(a){throw Error(a);})}},deleteserver:function(b,a){g()&&
d.Comm.del(f+"/servers/"+b,d.Keystone.params.token,function(b){a!=c&&a(b)},function(a){throw Error(a);})},changepasswordserver:function(b,a,h){a!=c&&e(b,{changePassword:{adminPass:a}},h)},rebootserverhard:function(b,a){e(b,{reboot:{type:"HARD"}},a)},rebootserversoft:function(b,a){e(b,{reboot:{type:"SOFT"}},a)},resizeserver:function(b,a,c){e(b,{resize:{flavorRef:a}},c)},confirmresizedserver:function(b,a){e(b,{confirmResize:null},a)},revertresizedserver:function(b,a){e(b,{revertResize:null},a)},startserver:function(b,
a){e(b,{"os-start":null},a)},stopserver:function(b,a){e(b,{"os-stop":null},a)},pauseserver:function(b,a){e(b,{pause:null},a)},unpauseserver:function(b,a){e(b,{unpause:null},a)},suspendserver:function(b,a){e(b,{suspend:null},a)},resumeserver:function(b,a){e(b,{resume:null},a)},createimage:function(b,a,d,f){a={createImage:{name:a}};a.createImage.metadata={};d!=c&&(a.createImage.metadata=d);e(b,a,f)},getflavorlist:function(b,a){if(g()){var h=f+"/flavors";b!=c&b&&(h+="/detail");d.Comm.get(h,d.Keystone.params.token,
function(b){a!=c&&a(b)},function(a){throw Error(a);})}},getflavordetail:function(b,a){g()&&d.Comm.get(f+"/flavors/"+b,d.Keystone.params.token,function(b){a!=c&&a(b)},function(a){throw Error(a);})},createflavor:function(b,a,h,e,j,k,l,m,n){if(g()){var o=f+"/flavors",b={flavor:{name:b,ram:a,vcpus:h,disk:e,id:j,swap:0,"OS-FLV-EXT-DATA:ephemeral":0,rxtx_factor:0}};k!=c&&(b.flavor["OS-FLV-EXT-DATA:ephemeral"]=k);l!=c&&(b.flavor.swap=l);m!=c&&(b.flavor.rxtx_factor=m);d.Comm.post(o,b,d.Keystone.params.token,
function(a){n!=c&&n(a)},function(a){throw Error(a);})}},deleteflavor:function(b,a){g()&&d.Comm.del(f+"/flavors/"+b,d.Keystone.params.token,function(b){a!=c&&a(b)},function(a){throw Error(a);})},getimagelist:function(b,a){if(g()){var h=f+"/images";b!=c&b&&(h+="/detail");d.Comm.get(h,d.Keystone.params.token,function(b){a!=c&&a(b)},function(a){throw Error(a);})}},getimagedetail:function(b,a){g()&&d.Comm.get(f+"/images/"+b,d.Keystone.params.token,function(b){a!=c&&a(b)},function(a){throw Error(a);})},
deleteimage:function(b,a){g()&&d.Comm.del(f+"/images/"+b,d.Keystone.params.token,function(b){a!=c&&a(b)},function(a){throw Error(a);})},getkeypairlist:function(b){g()&&d.Comm.get(f+"/os-keypairs",d.Keystone.params.token,function(a){b!=c&&b(a)},function(a){throw Error(a);})},createkeypair:function(b,a,e){if(g()){var i=f+"/os-keypairs",b={keypair:{name:b}};a!=c&&(b.keypair.public_key=public_key);d.Comm.post(i,b,d.Keystone.params.token,function(a){e!=c&&e(a)},function(a){throw Error(a);})}},deletekeypair:function(b,
a){g()&&d.Comm.del(f+"/os-keypairs/"+b,d.Keystone.params.token,function(b){a!=c&&a(b)},function(a){throw Error(a);})},getvncconsole:function(b,a,d){if(g()){if(a==c||!a)a="novnc";e(b,{"os-getVNCConsole":{type:a}},null,d)}},getconsoleoutput:function(b,a,d){if(g()){if(a==c||!a)a=35;e(b,{"os-getConsoleOutput":{length:a}},null,d)}},getattachedvolumes:function(b,a){g()&&d.Comm.get(f+"/servers/"+b+"/os-volume_attachments",d.Keystone.params.token,function(b){a!=c&&a(b)},function(a){throw Error(a);})},attachvolume:function(b,
a,e,i){g()&&(a==c||e==c||d.Comm.post(f+"/servers/"+b+"/os-volume_attachments",{volumeAttachment:{volumeId:a,device:e}},d.Keystone.params.token,function(a){i!=c&&i(a)},function(a){throw Error(a);}))},detachvolume:function(b,a,e){g()&&a!=c&&d.Comm.del(f+"/servers/"+b+"/os-volume_attachments/"+a,d.Keystone.params.token,function(a){e!=c&&e(a)},function(a){throw Error(a);})},getattachedvolume:function(b,a,e){g()&&a!=c&&d.Comm.get(f+"/servers/"+b+"/os-volume_attachments/"+a,d.Keystone.params.token,function(a){e!=
c&&e(a)},function(a){throw Error(a);})}}}(JSTACK);JSTACK.Nova.Volume=function(d,c){var f=c,g=function(){return d.Keystone!=c&&d.Keystone.params.currentstate==d.Keystone.STATES.AUTHENTICATED?(f=d.Keystone.getservice("volume").endpoints[0].adminURL,!0):!1};return{getvolumelist:function(e,b){if(g()){var a=f+"/volumes";e!=c&e&&(a+="/detail");d.Comm.get(a,d.Keystone.params.token,function(a){b!=c&&b(a)},function(a){throw Error(a);})}},createvolume:function(e,b,a,h){g()&&(e={volume:{size:e}},b!=c&&(e.volume.display_name=b),a!=c&&(e.volume.display_description=
a),d.Comm.post(f+"/volumes",e,d.Keystone.params.token,function(a){h!=c&&h(a)},function(a){throw Error(a);}))},deletevolume:function(e,b){g()&&d.Comm.del(f+"/volumes/"+e,d.Keystone.params.token,function(a){b!=c&&b(a)},function(a){throw Error(a);})},getvolume:function(e,b){g()&&d.Comm.get(f+"/volumes/"+e,d.Keystone.params.token,function(a){b!=c&&b(a)},function(a){throw Error(a);})},getsnapshotlist:function(e,b){if(g()){var a=f+"/snapshots";e!=c&e&&(a+="/detail");d.Comm.get(a,d.Keystone.params.token,
function(a){b!=c&&b(a)},function(a){throw Error(a);})}},createsnapshot:function(e,b,a,h){g()&&(e={snapshot:{volume_id:e,force:!0}},b!=c&&(e.snapshot.display_name=b),a!=c&&(e.snapshot.display_description=a),d.Comm.post(f+"/snapshots",e,d.Keystone.params.token,function(a){h!=c&&h(a)},function(a){throw Error(a);}))},deletesnapshot:function(e,b){g()&&d.Comm.del(f+"/snapshots/"+e,d.Keystone.params.token,function(a){b!=c&&b(a)},function(a){throw Error(a);})},getsnapshot:function(e,b){g()&&d.Comm.get(f+
"/snapshots/"+e,d.Keystone.params.token,function(a){b!=c&&b(a)},function(a){throw Error(a);})}}}(JSTACK);JSTACK.Glance=function(d,c){var f=c;return{getimagelist:function(g,e){var b;d.Keystone!=c&&d.Keystone.params.currentstate==d.Keystone.STATES.AUTHENTICATED?(f=d.Keystone.getservice("image").endpoints[0].adminURL,b=!0):b=!1;b&&(b=f+"/images",g!=c&g&&(b+="/detail"),d.Comm.get(b,d.Keystone.params.token,function(a){e!=c&&e(a)},function(a){throw Error(a);}))}}}(JSTACK);
